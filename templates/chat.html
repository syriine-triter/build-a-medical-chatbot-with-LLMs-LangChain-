<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Chatbot - AI Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-content">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="bot-info">
                    <h1>üè• Medical AI Assistant</h1>
                    <p class="status">
                        <span class="status-dot"></span>
                        En ligne - Pr√™t √† vous aider
                    </p>
                </div>
            </div>
        </div>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Cet outil est √† but √©ducatif uniquement. Consultez toujours un professionnel de sant√©.</span>
        </div>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <div class="mode-option active" data-mode="chat">
                <i class="fas fa-comments"></i>
                <span>Questions G√©n√©rales</span>
            </div>
            <div class="mode-option" data-mode="diagnose">
                <i class="fas fa-stethoscope"></i>
                <span>Diagnostic Sympt√¥mes</span>
            </div>
        </div>

        <!-- Messages Container -->
        <div class="messages-container" id="messagesContainer">
            <!-- Message de bienvenue -->
            <div class="message bot-message">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <p>Bonjour ! Je suis votre assistant m√©dical IA. Comment puis-je vous aider aujourd'hui ?</p>
                    <div class="message-suggestions">
                        <button class="suggestion-btn" onclick="sendSuggestion('What is diabetes?')">
                            Qu'est-ce que le diab√®te ?
                        </button>
                        <button class="suggestion-btn" onclick="sendSuggestion('Explain hypertension')">
                            Expliquer l'hypertension
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="input-container">
                <textarea 
                    id="userInput" 
                    placeholder="Tapez votre question ou d√©crivez vos sympt√¥mes..." 
                    rows="1"
                ></textarea>
                <button id="sendButton" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="input-footer">
                <span class="mode-indicator" id="modeIndicator">
                    <i class="fas fa-comments"></i> Mode: Questions G√©n√©rales
                </span>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'chat';

        // Gestion du s√©lecteur de mode
        document.querySelectorAll('.mode-option').forEach(option => {
            option.addEventListener('click', function() {
                // Retirer la classe active de tous
                document.querySelectorAll('.mode-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                
                // Ajouter la classe active √† celui cliqu√©
                this.classList.add('active');
                
                // Mettre √† jour le mode
                currentMode = this.dataset.mode;
                
                // Mettre √† jour l'indicateur
                const indicator = document.getElementById('modeIndicator');
                if (currentMode === 'diagnose') {
                    indicator.innerHTML = '<i class="fas fa-stethoscope"></i> Mode: Diagnostic Sympt√¥mes';
                } else {
                    indicator.innerHTML = '<i class="fas fa-comments"></i> Mode: Questions G√©n√©rales';
                }
                
                // Changer le placeholder
                const input = document.getElementById('userInput');
                if (currentMode === 'diagnose') {
                    input.placeholder = 'D√©crivez vos sympt√¥mes (ex: fever, headache, stiff neck)...';
                } else {
                    input.placeholder = 'Tapez votre question m√©dicale...';
                }
            });
        });

        // Auto-resize textarea
        const textarea = document.getElementById('userInput');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Envoyer avec Enter (Shift+Enter pour nouvelle ligne)
        textarea.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Fonction pour envoyer un message
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const question = input.value.trim();
            
            if (!question) return;
            
            // Afficher le message utilisateur
            addUserMessage(question);
            
            // Vider l'input
            input.value = '';
            input.style.height = 'auto';
            
            // Afficher le typing indicator
            showTypingIndicator();
            
            // D√©sactiver le bouton
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            
            try {
                // Envoyer la requ√™te
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        mode: currentMode
                    })
                });
                
                const data = await response.json();
                
                // Retirer le typing indicator
                removeTypingIndicator();
                
                if (data.success) {
                    addBotMessage(data.answer, data.sources);
                } else {
                    addBotMessage('D√©sol√©, une erreur est survenue: ' + data.error, []);
                }
                
            } catch (error) {
                removeTypingIndicator();
                addBotMessage('Erreur de connexion. Veuillez r√©essayer.', []);
            } finally {
                sendButton.disabled = false;
            }
        }

        // Fonction pour les suggestions
        function sendSuggestion(text) {
            document.getElementById('userInput').value = text;
            sendMessage();
        }

        // Ajouter un message utilisateur
        function addUserMessage(text) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.innerHTML = `
                <div class="message-content">
                    <p>${escapeHtml(text)}</p>
                    <span class="message-time">${getCurrentTime()}</span>
                </div>
                <div class="message-avatar">
                    <i class="fas fa-user"></i>
                </div>
            `;
            container.appendChild(messageDiv);
            scrollToBottom();
        }

        // Ajouter un message bot
        function addBotMessage(text, sources = []) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            
            let sourcesHtml = '';
            if (sources && sources.length > 0) {
                sourcesHtml = `
                    <div class="message-sources">
                        <i class="fas fa-book-medical"></i>
                        <span>Sources: ${sources.join(', ')}</span>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <p>${formatText(text)}</p>
                    ${sourcesHtml}
                    <span class="message-time">${getCurrentTime()}</span>
                </div>
            `;
            container.appendChild(messageDiv);
            scrollToBottom();
        }

        // Afficher le typing indicator
        function showTypingIndicator() {
            const container = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            scrollToBottom();
        }

        // Retirer le typing indicator
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Fonction utilitaires
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatText(text) {
            // Convertir les sauts de ligne en <br>
            text = escapeHtml(text);
            text = text.replace(/\n/g, '<br>');
            
            // D√©tecter les listes num√©rot√©es
            text = text.replace(/^(\d+)\.\s/gm, '<br><strong>$1.</strong> ');
            
            // Mettre en gras les titres entre **
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            return text;
        }
    </script>
</body>
</html>